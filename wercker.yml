box: node
build:
  steps:
    - npm-install
    - npm-test
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        repository: stevemostovoy/lunch-roulette-build
        tag: $WERCKER_GIT_COMMIT

push:
  box: stevemostovoy/lunch-roulette-build:$WERCKER_GIT_COMMIT
  steps:
    - npm-install:
        cwd: frontend
    - script:
        name: Compile frontend
        code: |
          MINIFY=1 ./frontend/node_modules/webpack/bin/webpack.js --progress
    - script:
        name: Install to /app
        code: |
          mkdir /app
          mv src /app/src
          mv resources /app/static
          mv node_modules /app/node_modules
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        repository: stevemostovoy/lunch-roulette
        tag: $WERCKER_GIT_COMMIT
        ports: "8000"
        env:
          - "PORT=8000"
          - "MODE=release"
        entrypoint: "/bin/bash /app/resources/entrypoint.sh"

deploy-rancher:
  steps:
    - swaggy/deploy-to-rancher:
        access_key: $RANCHER_ACCESS_KEY
        secret_key: $RANCHER_SECRET_KEY
        rancher_url: $RANCHER_URL
        https: true
        tag: $WERCKER_GIT_COMMIT
        stack_name: LunchRoulette
        service_name: lunch-roulette
        docker_org: stevemostovoy
        docker_image: lunch-roulette
        use_tag: true
        inplace: true
        start_first: true
